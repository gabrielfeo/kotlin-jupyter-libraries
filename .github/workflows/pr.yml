name: 'Check PR'

on:
  pull_request:
  workflow_dispatch:

jobs:
  check_renovate_matches:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Renovate Bot GitHub Action
        uses: renovatebot/github-action@v36.0.0
        with:
          token: ${{ secrets.RENOVATE_GITHUB_TOKEN }}
          configurationFile: '.github/workflows/renovate-config.js'
        env:
          RENOVATE_LOG_FILE: '/tmp/renovate.log'
          RENOVATE_LOG_FILE_LEVEL: 'info'
          RENOVATE_DRY_RUN: 'extract'
          RENOVATE_USE_BASE_BRANCH_CONFIG: 'merge'
          RENOVATE_BASE_BRANCHES: "${{ github.head_ref }}"
      - run: cat /tmp/renovate.log
      - name: 'Check Renovate log for unmatched dependencies'
        id: check
        shell: bash
        run: .github/scripts/check_renovate_matches.py /tmp/renovate.log | tee unmatched.log
      - name: 'Build failure PR comment'
        if: ${{ steps.check.outcome == 'failure' && github.event.pull_request }}
        run: |
          echo -e 'The following aren't matched by any Renovate manager:\n\n```' > comment.md
          cat unmatched.log >> comment.md
          echo -e '```\n' >> comment.md
      - name: Find existing comment
        uses: peter-evans/find-comment@v2
        if: ${{ steps.check.outcome == 'failure' && github.event.pull_request }}
        id: find-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: 'Generated API diff'
      - name: Create or update diff comment
        uses: peter-evans/create-or-update-comment@v2
        if: ${{ steps.check.outcome == 'failure' && github.event.pull_request }}
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          body-file: 'comment.md'
          edit-mode: replace
